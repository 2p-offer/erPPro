#  linux io模型

> 名词解释：

1. 文件描述符 FD: 是内核为每一个进程维护的该进程所打开的文件的记录表。当程序打开一个现有文件或者创建一个新文件的时候，内核为进程返回这个文件的描述符。只针对unix/linux 系统

2. 缓存io ： 即标准io，再linux 的缓存io机制中，操作系统会将io的数据缓存再文件系统的页缓存中。也就是说，数据会先被拷贝到系统内核的缓存页中，在由内核拷贝到应用程序的地址空间

3. io操作分为两个阶段。

   1. 等待数据准备
   2. 数据从系统内核拷贝到应用程序进程

   



##  阻塞IO

>  最原始的一种io模型，当一个socket请求过来后，整个进程处于阻塞状态，直到数据准备好，并被拷贝到用户进程，才会返回结果。

优点：能够及时返回数据，返回的数据就是用户想要获得的所有数据

缺点：吞吐量降低，整个进程处于阻塞状态是的程序性能下降



##  非阻塞IO

> 为了让用户进程在数据准备阶段不被阻塞。采取了轮询方式。每隔一段时间，来请求数据是否准备好。当确认数据准备好，则与阻塞io一样，处理数据。
>
> 就是将阻塞io前半部分的完全阻塞，改编成一段一段的小阻塞。但是在数据拷贝过程，还是完全阻塞的

在数据没有准备好时，轮询的请求过来后，不会阻塞进程，而是立即返回一个error。当用户进程收到error后，知道是内核数据还没有准备好，可以重新发送下次请求。所以在用户层上看起来不是阻塞的。

优点: 在数据准备期间，没有完全阻塞。用户可以在期间做一些别的事情

缺点：采用轮询的方式，数据准备完成可能在轮询期间。但是只有下次轮询才能获取到数据，导致数据获取不够及时。



##  多路复用IO

> 多路：可以处理多个io请求。 复用：复用一个线程来处理所有请求。

诞生初衷：非阻塞io，带来的问题是，用户进程反复请求（轮询），这占用了大量的cpu。如果能把这个轮询脱离用户，由别人辅助就好了。这就是 io多路复用。也就是select、poll、epoll做的事情。

1. select:

   select 函数 是内核级别的。也是采用轮询方式。与nio的区别在于，select可以同时监听多个端口，当有任何一个数据准备完成，用户进程就可对其进行数据处理。select 调用之后，进程是会被阻塞的，但是区别阻塞io在于，它不会等内核中所有的数据都准备完成，才返回数据准备完成，一旦有一部分数据准备完成，就会调用用户进程来请求处理。至于如何判断部分数据准备完成，则交由了内核处理。

   - 基本原理：select 函数监视的文件描述符分3类，分别是writefds、readfds、和exceptfds。调用后select函数会阻塞，直到有描述符就绪（有数据 可读、可写、或者有except），或者超时（timeout指定等待时间，如果立即返回设为null即可），函数返回。当select函数返回后，可以通过遍历fdset，来找到就绪的描述符。

   - 缺点： 

     1. select 单个进程打开的fd数量是有上限的，在/proc/sys/fs/file-max 配置。64位默认2048
     2. 对io的扫描时线性的，轮询方式，效率较低。因为每一次遍历都要扫描FD_SETSIZE个socket，不管是否活跃，都会被扫描到。
     3. 维护了一个存放大量fd的数据结构，导致内核拷贝到用户进程时，复制开销很大。

     

2. poll:

   poll与select 基本无二。区别在于，他基于链表实现，没有了缺点中第一条的数量上限。

3. epoll:

   epoll是select 和 poll的增强版本。epoll使用一个文件描述符来管理多个描述符。将用户关系的描述符存放在内核的事件表中。

   - 基本原理：epoll支持水平触发和边缘触发。边缘触发的特点在于，他会通知那些fd刚转为就绪状态，并且只会通知一次。另一个特点是，epoll不再采用轮询方式，而是全新的事件通知机制。通过 epoll_ctl注册fd。当fd处于就绪状态时，会采用类似callback的回调机制。激活这个fd

   - 优势：

     1. 几乎没有最大并发连接数的限制。
     2. 放弃了轮询的方式，而采用回调机制。不会随着fd的累加造成性能的线性下降
     3. 内存拷贝：利用mmap文件映射内存加速与内核之间的消息传递

   - 两种操作模式：

     - 水平触发：

       默认的操作方式。当内核通知用户某些fd已经就绪，如果你不对其进行处理【改变fd的就绪状态】，他会一直通知下去

     - 边缘触发：

       当内核通知用户某些fd已经就绪，即使你不对他做任何处理，内核也不会对你发送下一次通知。

4. select/poll/epoll 区别：

   - 最大连接数的区别： 
     - select 有较强的限制，在64位上，可能上限在 32*64;
     - poll基于链表存储，没有上限
     - epoll有非常大的上限，可能内存XG时，接近X * 10W
   - FD 增长后带来的问题：
     - select 与 poll一直，采用遍历所有fd方式，不管fd当前是否活跃，所以当fd与日增长后，性能线性下降
     - epoll采用回调机制，相当于只管理活跃的fd。如果活跃的fd比例不是非常高。在fd大量增长后，只会收到很少的影响
   - 消息传递方式
     - select 与 poll 通过内核数据拷贝到用户地址空间完成消息传递
     - epoll采用内核和用户空间共享一块内存来实现